#include "sys.h"
#include "delay.h"  
#include "usart.h"  
#include "led.h"
#include "key.h"
#include "lcd.h"
#include "timer.h" 
#include "math.h" 
#include "arm_math.h"  
#include "adc.h"
#include "dac.h"
#include "stdbool.h"
#include "AD9833.h"

#define xiangweizhi 0               //注释锁
#define test1       1               //任务一锁
#define meun        1               //波形里的菜单

#define FFT_LENGTH		1024 		//FFT长度，默认是1024点FFT
#define RESOLUTION 2048
float fft_inputbuf[FFT_LENGTH*2];	//FFT输入数组(一定要大于两倍FFT长度)
float fft_outputbuf[FFT_LENGTH];	//FFT输出数组
float kaiser[1024]={0.789848314825112f, 0.790619838667604f, 0.791390228324344f, 0.792159481709385f, 0.792927596739707f, 0.793694571335223f, 0.794460403418787f, 0.795225090916202f, 0.795988631756221f, 0.79675102387056f, 0.7975122651939f, 0.798272353663893f, 0.799031287221172f, 0.799789063809356f, 0.800545681375052f, 0.80130113786787f, 0.802055431240421f, 0.802808559448327f, 0.80356052045023f, 0.804311312207791f, 0.805060932685704f, 0.805809379851699f, 0.806556651676545f, 0.807302746134065f, 0.808047661201132f, 0.808791394857682f, 0.809533945086719f, 0.81027530987432f, 0.811015487209642f, 0.811754475084929f, 0.812492271495514f, 0.813228874439833f, 0.813964281919424f, 0.814698491938938f, 0.81543150250614f, 0.81616331163192f, 0.816893917330299f, 0.817623317618431f, 0.818351510516613f, 0.81907849404829f, 0.81980426624006f, 0.820528825121683f, 0.821252168726084f, 0.821974295089359f, 0.822695202250785f, 0.823414888252822f, 0.82413335114112f, 0.824850588964528f, 0.825566599775095f, 0.826281381628079f, 0.826994932581955f, 0.827707250698416f, 0.828418334042384f, 0.829128180682011f, 0.829836788688691f, 0.83054415613706f, 0.831250281105006f, 0.831955161673674f, 0.83265879592747f, 0.83336118195407f, 0.834062317844423f, 0.83476220169276f, 0.835460831596597f, 0.836158205656744f, 0.836854321977305f, 0.837549178665694f, 0.83824277383263f, 0.838935105592148f, 0.839626172061607f, 0.840315971361691f, 0.841004501616419f, 0.841691760953149f, 0.84237774750258f, 0.843062459398768f, 0.843745894779119f, 0.844428051784407f, 0.845108928558768f, 0.845788523249717f, 0.846466834008146f, 0.847143858988331f, 0.847819596347941f, 0.848494044248041f, 0.849167200853097f, 0.849839064330986f, 0.850509632852996f, 0.851178904593836f, 0.851846877731638f, 0.852513550447966f, 0.853178920927821f, 0.853842987359645f, 0.854505747935327f, 0.855167200850211f, 0.8558273443031f, 0.856486176496257f, 0.857143695635421f, 0.857799899929802f, 0.858454787592093f, 0.859108356838474f, 0.859760605888617f, 0.86041153296569f, 0.861061136296365f, 0.861709414110825f, 0.862356364642765f, 0.863001986129398f, 0.863646276811467f, 0.864289234933241f, 0.864930858742528f, 0.865571146490676f, 0.86621009643258f, 0.866847706826688f, 0.867483975935006f, 0.868118902023102f, 0.868752483360114f, 0.869384718218753f, 0.870015604875309f, 0.870645141609657f, 0.871273326705262f, 0.871900158449185f, 0.872525635132086f, 0.873149755048234f, 0.873772516495505f, 0.874393917775395f, 0.875013957193019f, 0.875632633057123f, 0.87624994368008f, 0.876865887377906f, 0.877480462470256f, 0.878093667280434f, 0.878705500135397f, 0.879315959365763f, 0.879925043305809f, 0.880532750293484f, 0.881139078670412f, 0.881744026781891f, 0.882347592976909f, 0.88294977560814f, 0.883550573031953f, 0.884149983608417f, 0.884748005701306f, 0.885344637678103f, 0.885939877910005f, 0.886533724771932f, 0.887126176642526f, 0.88771723190416f, 0.888306888942942f, 0.888895146148721f, 0.889482001915088f, 0.890067454639387f, 0.890651502722716f, 0.891234144569934f, 0.891815378589662f, 0.892395203194295f, 0.892973616799998f, 0.893550617826721f, 0.894126204698194f, 0.894700375841939f, 0.895273129689273f, 0.895844464675309f, 0.896414379238969f, 0.89698287182298f, 0.897549940873885f, 0.898115584842044f, 0.898679802181642f, 0.899242591350692f, 0.899803950811039f, 0.900363879028368f, 0.900922374472205f, 0.901479435615924f, 0.902035060936751f, 0.902589248915769f, 0.903141998037922f, 0.903693306792021f, 0.904243173670748f, 0.904791597170662f, 0.905338575792199f, 0.905884108039683f, 0.906428192421327f, 0.906970827449238f, 0.907512011639422f, 0.908051743511789f, 0.908590021590157f, 0.909126844402255f, 0.909662210479734f, 0.910196118358162f, 0.910728566577035f, 0.911259553679783f, 0.911789078213766f, 0.91231713873029f, 0.912843733784601f, 0.913368861935895f, 0.913892521747325f, 0.914414711785997f, 0.914935430622983f, 0.91545467683332f, 0.915972448996018f, 0.916488745694062f, 0.917003565514416f, 0.917516907048031f, 0.918028768889845f, 0.91853914963879f, 0.919048047897796f, 0.919555462273795f, 0.920061391377726f, 0.920565833824535f, 0.921068788233189f, 0.921570253226669f, 0.922070227431983f, 0.922568709480166f, 0.923065698006283f, 0.92356119164944f, 0.924055189052778f, 0.924547688863487f, 0.925038689732806f, 0.925528190316023f, 0.926016189272488f, 0.926502685265611f, 0.926987676962868f, 0.927471163035804f, 0.927953142160038f, 0.92843361301527f, 0.928912574285277f, 0.929390024657929f, 0.92986596282518f, 0.930340387483084f, 0.930813297331788f, 0.931284691075547f, 0.93175456742272f, 0.932222925085776f, 0.932689762781301f, 0.933155079229998f, 0.933618873156692f, 0.934081143290337f, 0.934541888364016f, 0.935001107114947f, 0.935458798284486f, 0.935914960618132f, 0.936369592865529f, 0.936822693780474f, 0.937274262120915f, 0.93772429664896f, 0.938172796130878f, 0.938619759337102f, 0.939065185042238f, 0.939509072025063f, 0.939951419068531f, 0.940392224959777f, 0.940831488490123f, 0.941269208455075f, 0.941705383654335f, 0.942140012891799f, 0.942573094975563f, 0.943004628717927f, 0.943434612935397f, 0.94386304644869f, 0.944289928082738f, 0.94471525666669f, 0.945139031033918f, 0.945561250022019f, 0.945981912472817f, 0.946401017232372f, 0.946818563150978f, 0.947234549083169f, 0.947648973887721f, 0.94806183642766f, 0.94847313557026f, 0.94888287018705f, 0.949291039153815f, 0.949697641350603f, 0.950102675661725f, 0.95050614097576f, 0.950908036185559f, 0.951308360188248f, 0.95170711188523f, 0.952104290182191f, 0.952499893989102f, 0.95289392222022f, 0.953286373794099f, 0.953677247633582f, 0.954066542665816f, 0.954454257822246f, 0.954840392038625f, 0.955224944255013f, 0.955607913415783f, 0.955989298469622f, 0.956369098369536f, 0.956747312072853f, 0.957123938541227f, 0.957498976740636f, 0.957872425641394f, 0.958244284218148f, 0.958614551449882f, 0.958983226319922f, 0.959350307815939f, 0.959715794929949f, 0.960079686658321f, 0.960441982001774f, 0.960802679965388f, 0.9611617795586f, 0.961519279795211f, 0.961875179693388f, 0.962229478275665f, 0.962582174568953f, 0.962933267604532f, 0.963282756418064f, 0.963630640049591f, 0.963976917543539f, 0.964321587948723f, 0.964664650318344f, 0.965006103710001f, 0.965345947185684f, 0.965684179811786f, 0.966020800659099f, 0.966355808802822f, 0.966689203322559f, 0.967020983302327f, 0.967351147830554f, 0.967679696000086f, 0.968006626908187f, 0.968331939656543f, 0.968655633351263f, 0.968977707102887f, 0.969298160026383f, 0.96961699124115f, 0.969934199871026f, 0.970249785044286f, 0.970563745893645f, 0.970876081556264f, 0.971186791173748f, 0.971495873892154f, 0.971803328861987f, 0.972109155238211f, 0.972413352180245f, 0.972715918851965f, 0.973016854421714f, 0.973316158062297f, 0.973613828950988f, 0.973909866269529f, 0.974204269204138f, 0.974497036945505f, 0.974788168688799f, 0.975077663633668f, 0.975365520984245f, 0.975651739949147f, 0.975936319741478f, 0.976219259578833f, 0.976500558683298f, 0.976780216281457f, 0.977058231604388f, 0.97733460388767f, 0.977609332371386f, 0.97788241630012f, 0.978153854922966f, 0.978423647493525f, 0.978691793269912f, 0.978958291514753f, 0.979223141495192f, 0.979486342482891f, 0.979747893754033f, 0.980007794589322f, 0.980266044273991f, 0.980522642097797f, 0.980777587355028f, 0.981030879344505f, 0.981282517369581f, 0.981532500738145f, 0.981780828762627f, 0.982027500759995f, 0.982272516051761f, 0.982515873963982f, 0.98275757382726f, 0.982997614976748f, 0.983235996752149f, 0.983472718497719f, 0.98370777956227f, 0.983941179299171f, 0.984172917066348f, 0.984402992226292f, 0.984631404146054f, 0.984858152197251f, 0.985083235756068f, 0.985306654203259f, 0.985528406924148f, 0.985748493308631f, 0.985966912751182f, 0.986183664650849f, 0.98639874841126f, 0.986612163440622f, 0.986823909151726f, 0.987033984961945f, 0.98724239029324f, 0.987449124572158f, 0.987654187229838f, 0.987857577702007f, 0.988059295428988f, 0.988259339855697f, 0.988457710431646f, 0.988654406610948f, 0.988849427852313f, 0.989042773619055f, 0.98923444337909f, 0.989424436604938f, 0.989612752773727f, 0.989799391367194f, 0.989984351871685f, 0.990167633778156f, 0.990349236582178f, 0.990529159783937f, 0.990707402888232f, 0.990883965404484f, 0.991058846846731f, 0.991232046733632f, 0.991403564588466f, 0.991573399939141f, 0.991741552318186f, 0.991908021262759f, 0.992072806314644f, 0.992235907020255f, 0.99239732293064f, 0.992557053601474f, 0.992715098593072f, 0.99287145747038f, 0.99302612980298f, 0.993179115165096f, 0.993330413135586f, 0.993480023297953f, 0.993627945240338f, 0.993774178555529f, 0.993918722840954f, 0.99406157769869f, 0.994202742735461f, 0.994342217562635f, 0.994480001796234f, 0.994616095056928f, 0.994750496970039f, 0.994883207165543f, 0.995014225278068f, 0.995143550946898f, 0.995271183815974f, 0.995397123533893f, 0.995521369753913f, 0.995643922133947f, 0.995764780336574f, 0.995883944029031f, 0.996001412883219f, 0.996117186575702f, 0.996231264787709f, 0.996343647205136f, 0.996454333518544f, 0.996563323423162f, 0.996670616618888f, 0.996776212810291f, 0.996880111706607f, 0.996982313021747f, 0.997082816474292f, 0.997181621787496f, 0.99727872868929f, 0.997374136912276f, 0.997467846193733f, 0.997559856275619f, 0.997650166904566f, 0.997738777831886f, 0.997825688813569f, 0.997910899610286f, 0.997994409987386f, 0.998076219714901f, 0.998156328567545f, 0.998234736324713f, 0.998311442770485f, 0.998386447693625f, 0.998459750887579f, 0.998531352150482f, 0.998601251285151f, 0.998669448099092f, 0.998735942404498f, 0.998800734018249f, 0.998863822761912f, 0.998925208461746f, 0.998984890948697f, 0.999042870058399f, 0.999099145631182f, 0.999153717512062f, 0.999206585550747f, 0.99925774960164f, 0.999307209523832f, 0.999354965181109f, 0.999401016441951f, 0.999445363179529f, 0.999488005271711f, 0.999528942601057f, 0.999568175054821f, 0.999605702524955f, 0.999641524908105f, 0.999675642105612f, 0.999708054023514f, 0.999738760572544f, 0.999767761668133f, 0.999795057230408f, 0.999820647184195f, 0.999844531459013f, 0.999866709989083f, 0.999887182713323f, 0.999905949575346f, 0.999923010523466f, 0.999938365510695f, 0.999952014494743f, 0.999963957438017f, 0.999974194307625f, 0.999982725075373f, 0.999989549717766f, 0.999994668216008f, 0.999998080556001f, 0.999999786728347f, 0.999999786728347f, 0.999998080556001f, 0.999994668216008f, 0.999989549717766f, 0.999982725075373f, 0.999974194307625f, 0.999963957438017f, 0.999952014494743f, 0.999938365510695f, 0.999923010523466f, 0.999905949575346f, 0.999887182713323f, 0.999866709989083f, 0.999844531459013f, 0.999820647184195f, 0.999795057230408f, 0.999767761668133f, 0.999738760572544f, 0.999708054023514f, 0.999675642105612f, 0.999641524908105f, 0.999605702524955f, 0.999568175054821f, 0.999528942601057f, 0.999488005271711f, 0.999445363179529f, 0.999401016441951f, 0.999354965181109f, 0.999307209523832f, 0.99925774960164f, 0.999206585550747f, 0.999153717512062f, 0.999099145631182f, 0.999042870058399f, 0.998984890948697f, 0.998925208461746f, 0.998863822761912f, 0.998800734018249f, 0.998735942404498f, 0.998669448099092f, 0.998601251285151f, 0.998531352150482f, 0.998459750887579f, 0.998386447693625f, 0.998311442770485f, 0.998234736324713f, 0.998156328567545f, 0.998076219714901f, 0.997994409987386f, 0.997910899610286f, 0.997825688813569f, 0.997738777831886f, 0.997650166904566f, 0.997559856275619f, 0.997467846193733f, 0.997374136912276f, 0.99727872868929f, 0.997181621787496f, 0.997082816474292f, 0.996982313021747f, 0.996880111706607f, 0.996776212810291f, 0.996670616618888f, 0.996563323423162f, 0.996454333518544f, 0.996343647205136f, 0.996231264787709f, 0.996117186575702f, 0.996001412883219f, 0.995883944029031f, 0.995764780336574f, 0.995643922133947f, 0.995521369753913f, 0.995397123533893f, 0.995271183815974f, 0.995143550946898f, 0.995014225278068f, 0.994883207165543f, 0.994750496970039f, 0.994616095056928f, 0.994480001796234f, 0.994342217562635f, 0.994202742735461f, 0.99406157769869f, 0.993918722840954f, 0.993774178555529f, 0.993627945240338f, 0.993480023297953f, 0.993330413135586f, 0.993179115165096f, 0.99302612980298f, 0.99287145747038f, 0.992715098593072f, 0.992557053601474f, 0.99239732293064f, 0.992235907020255f, 0.992072806314644f, 0.991908021262759f, 0.991741552318186f, 0.991573399939141f, 0.991403564588466f, 0.991232046733632f, 0.991058846846731f, 0.990883965404484f, 0.990707402888232f, 0.990529159783937f, 0.990349236582178f, 0.990167633778156f, 0.989984351871685f, 0.989799391367194f, 0.989612752773727f, 0.989424436604938f, 0.98923444337909f, 0.989042773619055f, 0.988849427852313f, 0.988654406610948f, 0.988457710431646f, 0.988259339855697f, 0.988059295428988f, 0.987857577702007f, 0.987654187229838f, 0.987449124572158f, 0.98724239029324f, 0.987033984961945f, 0.986823909151726f, 0.986612163440622f, 0.98639874841126f, 0.986183664650849f, 0.985966912751182f, 0.985748493308631f, 0.985528406924148f, 0.985306654203259f, 0.985083235756068f, 0.984858152197251f, 0.984631404146054f, 0.984402992226292f, 0.984172917066348f, 0.983941179299171f, 0.98370777956227f, 0.983472718497719f, 0.983235996752149f, 0.982997614976748f, 0.98275757382726f, 0.982515873963982f, 0.982272516051761f, 0.982027500759995f, 0.981780828762627f, 0.981532500738145f, 0.981282517369581f, 0.981030879344505f, 0.980777587355028f, 0.980522642097797f, 0.980266044273991f, 0.980007794589322f, 0.979747893754033f, 0.979486342482891f, 0.979223141495192f, 0.978958291514753f, 0.978691793269912f, 0.978423647493525f, 0.978153854922966f, 0.97788241630012f, 0.977609332371386f, 0.97733460388767f, 0.977058231604388f, 0.976780216281457f, 0.976500558683298f, 0.976219259578833f, 0.975936319741478f, 0.975651739949147f, 0.975365520984245f, 0.975077663633668f, 0.974788168688799f, 0.974497036945505f, 0.974204269204138f, 0.973909866269529f, 0.973613828950988f, 0.973316158062297f, 0.973016854421714f, 0.972715918851965f, 0.972413352180245f, 0.972109155238211f, 0.971803328861987f, 0.971495873892154f, 0.971186791173748f, 0.970876081556264f, 0.970563745893645f, 0.970249785044286f, 0.969934199871026f, 0.96961699124115f, 0.969298160026383f, 0.968977707102887f, 0.968655633351263f, 0.968331939656543f, 0.968006626908187f, 0.967679696000086f, 0.967351147830554f, 0.967020983302327f, 0.966689203322559f, 0.966355808802822f, 0.966020800659099f, 0.965684179811786f, 0.965345947185684f, 0.965006103710001f, 0.964664650318344f, 0.964321587948723f, 0.963976917543539f, 0.963630640049591f, 0.963282756418064f, 0.962933267604532f, 0.962582174568953f, 0.962229478275665f, 0.961875179693388f, 0.961519279795211f, 0.9611617795586f, 0.960802679965388f, 0.960441982001774f, 0.960079686658321f, 0.959715794929949f, 0.959350307815939f, 0.958983226319922f, 0.958614551449882f, 0.958244284218148f, 0.957872425641394f, 0.957498976740636f, 0.957123938541227f, 0.956747312072853f, 0.956369098369536f, 0.955989298469622f, 0.955607913415783f, 0.955224944255013f, 0.954840392038625f, 0.954454257822246f, 0.954066542665816f, 0.953677247633582f, 0.953286373794099f, 0.95289392222022f, 0.952499893989102f, 0.952104290182191f, 0.95170711188523f, 0.951308360188248f, 0.950908036185559f, 0.95050614097576f, 0.950102675661725f, 0.949697641350603f, 0.949291039153815f, 0.94888287018705f, 0.94847313557026f, 0.94806183642766f, 0.947648973887721f, 0.947234549083169f, 0.946818563150978f, 0.946401017232372f, 0.945981912472817f, 0.945561250022019f, 0.945139031033918f, 0.94471525666669f, 0.944289928082738f, 0.94386304644869f, 0.943434612935397f, 0.943004628717927f, 0.942573094975563f, 0.942140012891799f, 0.941705383654335f, 0.941269208455075f, 0.940831488490123f, 0.940392224959777f, 0.939951419068531f, 0.939509072025063f, 0.939065185042238f, 0.938619759337102f, 0.938172796130878f, 0.93772429664896f, 0.937274262120915f, 0.936822693780474f, 0.936369592865529f, 0.935914960618132f, 0.935458798284486f, 0.935001107114947f, 0.934541888364016f, 0.934081143290337f, 0.933618873156692f, 0.933155079229998f, 0.932689762781301f, 0.932222925085776f, 0.93175456742272f, 0.931284691075547f, 0.930813297331788f, 0.930340387483084f, 0.92986596282518f, 0.929390024657929f, 0.928912574285277f, 0.92843361301527f, 0.927953142160038f, 0.927471163035804f, 0.926987676962868f, 0.926502685265611f, 0.926016189272488f, 0.925528190316023f, 0.925038689732806f, 0.924547688863487f, 0.924055189052778f, 0.92356119164944f, 0.923065698006283f, 0.922568709480166f, 0.922070227431983f, 0.921570253226669f, 0.921068788233189f, 0.920565833824535f, 0.920061391377726f, 0.919555462273795f, 0.919048047897796f, 0.91853914963879f, 0.918028768889845f, 0.917516907048031f, 0.917003565514416f, 0.916488745694062f, 0.915972448996018f, 0.91545467683332f, 0.914935430622983f, 0.914414711785997f, 0.913892521747325f, 0.913368861935895f, 0.912843733784601f, 0.91231713873029f, 0.911789078213766f, 0.911259553679783f, 0.910728566577035f, 0.910196118358162f, 0.909662210479734f, 0.909126844402255f, 0.908590021590157f, 0.908051743511789f, 0.907512011639422f, 0.906970827449238f, 0.906428192421327f, 0.905884108039683f, 0.905338575792199f, 0.904791597170662f, 0.904243173670748f, 0.903693306792021f, 0.903141998037922f, 0.902589248915769f, 0.902035060936751f, 0.901479435615924f, 0.900922374472205f, 0.900363879028368f, 0.899803950811039f, 0.899242591350692f, 0.898679802181642f, 0.898115584842044f, 0.897549940873885f, 0.89698287182298f, 0.896414379238969f, 0.895844464675309f, 0.895273129689273f, 0.894700375841939f, 0.894126204698194f, 0.893550617826721f, 0.892973616799998f, 0.892395203194295f, 0.891815378589662f, 0.891234144569934f, 0.890651502722716f, 0.890067454639387f, 0.889482001915088f, 0.888895146148721f, 0.888306888942942f, 0.88771723190416f, 0.887126176642526f, 0.886533724771932f, 0.885939877910005f, 0.885344637678103f, 0.884748005701306f, 0.884149983608417f, 0.883550573031953f, 0.88294977560814f, 0.882347592976909f, 0.881744026781891f, 0.881139078670412f, 0.880532750293484f, 0.879925043305809f, 0.879315959365763f, 0.878705500135397f, 0.878093667280434f, 0.877480462470256f, 0.876865887377906f, 0.87624994368008f, 0.875632633057123f, 0.875013957193019f, 0.874393917775395f, 0.873772516495505f, 0.873149755048234f, 0.872525635132086f, 0.871900158449185f, 0.871273326705262f, 0.870645141609657f, 0.870015604875309f, 0.869384718218753f, 0.868752483360114f, 0.868118902023102f, 0.867483975935006f, 0.866847706826688f, 0.86621009643258f, 0.865571146490676f, 0.864930858742528f, 0.864289234933241f, 0.863646276811467f, 0.863001986129398f, 0.862356364642765f, 0.861709414110825f, 0.861061136296365f, 0.86041153296569f, 0.859760605888617f, 0.859108356838474f, 0.858454787592093f, 0.857799899929802f, 0.857143695635421f, 0.856486176496257f, 0.8558273443031f, 0.855167200850211f, 0.854505747935327f, 0.853842987359645f, 0.853178920927821f, 0.852513550447966f, 0.851846877731638f, 0.851178904593836f, 0.850509632852996f, 0.849839064330986f, 0.849167200853097f, 0.848494044248041f, 0.847819596347941f, 0.847143858988331f, 0.846466834008146f, 0.845788523249717f, 0.845108928558768f, 0.844428051784407f, 0.843745894779119f, 0.843062459398768f, 0.84237774750258f, 0.841691760953149f, 0.841004501616419f, 0.840315971361691f, 0.839626172061607f, 0.838935105592148f, 0.83824277383263f, 0.837549178665694f, 0.836854321977305f, 0.836158205656744f, 0.835460831596597f, 0.83476220169276f, 0.834062317844423f, 0.83336118195407f, 0.83265879592747f, 0.831955161673674f, 0.831250281105006f, 0.83054415613706f, 0.829836788688691f, 0.829128180682011f, 0.828418334042384f, 0.827707250698416f, 0.826994932581955f, 0.826281381628079f, 0.825566599775095f, 0.824850588964528f, 0.82413335114112f, 0.823414888252822f, 0.822695202250785f, 0.821974295089359f, 0.821252168726084f, 0.820528825121683f, 0.81980426624006f, 0.81907849404829f, 0.818351510516613f, 0.817623317618431f, 0.816893917330299f, 0.81616331163192f, 0.81543150250614f, 0.814698491938938f, 0.813964281919424f, 0.813228874439833f, 0.812492271495514f, 0.811754475084929f, 0.811015487209642f, 0.81027530987432f, 0.809533945086719f, 0.808791394857682f, 0.808047661201132f, 0.807302746134065f, 0.806556651676545f, 0.805809379851699f, 0.805060932685704f, 0.804311312207791f, 0.80356052045023f, 0.802808559448327f, 0.802055431240421f, 0.80130113786787f, 0.800545681375052f, 0.799789063809356f, 0.799031287221172f, 0.798272353663893f, 0.7975122651939f, 0.79675102387056f, 0.795988631756221f, 0.795225090916202f, 0.794460403418787f, 0.793694571335223f, 0.792927596739707f, 0.792159481709385f, 0.791390228324344f, 0.790619838667604f, 0.789848314825112f};
u8 timeout;//定时器溢出次数
static char oscilloscopeLevel ;   //记录信号发生器射频大小
    
#if xiangweizhi //测试别项相位值（2）
u16   freamplen; // freamp长度的一半    
const u32  fft_sample_freq=84000000/(65535*84);  //fft采样频率 为信号的3到6倍   幅值最准确  
float freamp[50];//获取各次谐波频率和幅?   
float zhiliu1,HZ1,amp1,phase1;    
#endif
void clear_point(u16 num);//更新显示屏当前列	
void Set_BackGround(void);//设置背景
void Lcd_DrawNetwork(void);//画网格
float get_vpp(float *buf);//获取峰峰值
void DrawOscillogram(float *buf);//画波形图
void DrawSpectrum(float *buf,u32 f);//画出幅频特性图
u32 get_freq(float *buff);//得到最高频率
void Collect_ADC_LEVEL(float *buff);//采集电平
void Add_Kwindow(float *buff);//在函数上加Kaiser窗
//u32 get_arg(float *buff);   //获取相位
u32 get_arg(float *buffx,float *buffy);   //获取相位
int fft_getpeak(float *inputx,float *input,float *output,u16 inlen,u8 x,u8 N,float y); //测试获取许多东西
	
int main(void)
{ 
  arm_cfft_radix4_instance_f32 scfft;
 	u8 key,t;
    static bool isAudioDetectionMode = true;
	float Adresult = 0;
	u32 freq,arg;
    u8 arg_buff[20]={0};
	u16 i; 
	u8 Vpp_buff[20] = {0};
	u8 Freq_buff[20]={0};
    u8 show[20]={0};

    oscilloscopeLevel = 0;
	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);//设置系统中断优先级分组2
	delay_init(168);  //初始化延时函数
	uart_init(115200);		//初始化串口波特率为115200
	//初始化：
	LED_Init();					//初始化LED
	KEY_Init();					//初始化按键
 	LCD_Init();					//初始化LCD
    AD9833_Init();              //初始化信号发生器
	Adc_Init();                 //初始化ADC
	DAC_Mode_Init();			//产生正弦波
	LCD_Display_Dir(1);	
	Set_BackGround();	        //显示背景
	Lcd_DrawNetwork();
    
    sprintf((char*)show,"test1");	
    LCD_ShowString(60,10,210,24,24,show);
    sprintf((char*)show,"test2");
    LCD_ShowString(60,40,210,24,24,show);
    sprintf((char*)show,"test3");
	LCD_ShowString(60,70,210,24,24,show);
	LED0 = 0;
	TIM3_Int_Init(65535,84-1);	//1Mhz计数频率,最大计时65ms左右超出   
	arm_cfft_radix4_init_f32(&scfft,FFT_LENGTH,0,1);//初始化scfft结构体，设定FFT相关参数
 	while(1)
	{
			key=KEY_Scan(0);            //设想按键一和二分别控制任务3输出功率
			if(key==WKUP_PRES)
			{
                oscilloscopeLevel++;
                AD9833_Square_Wave(0,10000,0,0); //2:频率 4：相位
                sprintf((char*)show,"PowerOutput%d",oscilloscopeLevel);	
                LCD_ShowString(320,10,210,24,24,show);
            }
            else if(key==KEY1_PRES)
            {
                oscilloscopeLevel--;
                AD9833_Setup(0,50000.0,0,50,1);
                sprintf((char*)show,"PowerOutput%d",oscilloscopeLevel);	
                LCD_ShowString(320,10,210,24,24,show);
            }
            
            
			if(key == KEY0_PRES)
			{	
                while(1)
                {
                   #if meun
               key=KEY_Scan(1); 
            if(key==WKUP_PRES)
			{
                oscilloscopeLevel++;
                AD9833_Square_Wave(0,10000,0,0); //2:频率 4：相位
                sprintf((char*)show,"PowerOutput%d",oscilloscopeLevel);	
                LCD_ShowString(320,10,210,24,24,show);
                
            }
            else if(key==KEY1_PRES)
            {
                oscilloscopeLevel--;
                AD9833_Setup(0,50000.0,0,50,1);
                sprintf((char*)show,"PowerOutput%d",oscilloscopeLevel);	
                LCD_ShowString(320,10,210,24,24,show);
            }
            else if(key == KEY2_PRES)          //切换音频信号隔断
           {    
               delay_ms(10);//去抖动
               while(KEY2_PRES == 1);
               isAudioDetectionMode = !isAudioDetectionMode; // 切换模式
            if(isAudioDetectionMode) {
                // 切换到音频信号检测模式 
                sprintf((char*)show,"DetectionMode:1");	
                LCD_ShowString(300,250,210,24,24,show);
           } else 
            {
                // 切换到人声检测模式
                sprintf((char*)show,"DetectionMode:0");	
                LCD_ShowString(300,250,210,24,24,show);
            }
               
           }
                   #endif


                    
                
			Collect_ADC_LEVEL(fft_inputbuf);
			//if(show_flag==1)
			DrawOscillogram(fft_inputbuf);//画波形
			Adresult = get_vpp(fft_inputbuf);//峰峰值mv
			Add_Kwindow(fft_inputbuf);
			arm_cfft_radix4_f32(&scfft,fft_inputbuf);	//FFT计算（基4）
			arm_cmplx_mag_f32(fft_inputbuf,fft_outputbuf,FFT_LENGTH);	//把运算结果复数求模得幅值 
			#if 0
            for(i=0;i<FFT_LENGTH;i++)                                   //验证幅值
			{
				printf("output:%.2f,%.2f\n",fft_inputbuf[2*i],fft_outputbuf[i]);
			} 
            #endif
			freq=get_freq(fft_outputbuf);
            #if xiangweizhi //测试别项相位值（2）
            freamplen=fft_getpeak(fft_inputbuf,fft_outputbuf+1,freamp,FFT_LENGTH/2,10,5,0.2);//寻找基波和谐波
            zhiliu1=fft_outputbuf[0]/FFT_LENGTH;//直流 
            HZ1=freamp[0];//频率
            amp1=freamp[1];//幅度
            phase1=freamp[2];//相位
            freamp[0]=0;freamp[1]=0;freamp[2]=0;	
//            printf("zhiliu1:%.2f\r\n",zhiliu1);
            printf("HZ1:%.2f\r\n",HZ1);
//            printf("amp1:%.2f\r\n",amp1);
            printf("phase1:%.2f\r\n",phase1);
            #endif
            arg = get_arg(fft_outputbuf,fft_inputbuf);
			//if(show_flag!=1)
			//DrawSpectrum(fft_outputbuf,freq);
//			Adresult =0.0281682f+2.04374f*Adresult-0.05f+0.00004f*(freq-1000);//曲线拟合结果
			POINT_COLOR = WHITE;
			BACK_COLOR = DARKBLUE;
			sprintf((char*)Freq_buff,"Fs = %dHz",freq);
			LCD_ShowString(60,10,210,24,24,Freq_buff);
            #if test1                   //任务一
            if(freq > 100)
            {

               LED0 = 0;
            }
            else LED0 = 1;
            #endif
//            printf("Freq_buff:%d\n",freq);
            
			sprintf((char*)Vpp_buff,"VPP = %0.2fV",Adresult);		
			LCD_ShowString(60,40,210,24,24,Vpp_buff);
            sprintf((char*)Vpp_buff,"arg = %d",arg);		
			LCD_ShowString(60,70,210,24,24,Vpp_buff);
		
                }
            }
                
        
        
           else if(key == KEY2_PRES)          //切换音频信号隔断
           {    
               delay_ms(10);//去抖动
               while(KEY2_PRES == 1);
               isAudioDetectionMode = !isAudioDetectionMode; // 切换模式
            if(isAudioDetectionMode) {
                // 切换到音频信号检测模式 
                sprintf((char*)show,"DetectionMode:1");	
                LCD_ShowString(300,250,210,24,24,show);
           } else 
            {
                // 切换到人声检测模式
                sprintf((char*)show,"DetectionMode:0");	
                LCD_ShowString(300,250,210,24,24,show);
            }
               
           }
           else delay_ms(10);
		t++;
		if((t%10)==0)LED0=!LED0;	
	}
}


void clear_point(u16 num)//更新显示屏当前列
{
	u16 index_clear_lie = 0; 
	u16 Y_init=lcddev.height-20;
	POINT_COLOR = DARKBLUE ;
	for(index_clear_lie = 0;index_clear_lie < lcddev.height;index_clear_lie++)
	{		
		if((num!=lcddev.width/2) && (index_clear_lie!=Y_init))
		LCD_DrawPoint(num,index_clear_lie);
	}
	if(!(num%40))//判断hang是否为50的倍数 画列点
	{
		for(index_clear_lie = 10;index_clear_lie <=lcddev.height;index_clear_lie += 10)
		{		
			LCD_Fast_DrawPoint(num ,index_clear_lie,WHITE );
		}
	}
	if(!(num%10))//判断hang是否为10的倍数 画行点
	{
		for(index_clear_lie = 40;index_clear_lie <=lcddev.height;index_clear_lie += 40)
		{		
			LCD_Fast_DrawPoint(num ,index_clear_lie,WHITE );
		}
	}	
	POINT_COLOR = YELLOW;	
}
void Collect_ADC_LEVEL(float *buff)
{
		u16 i = 0;
		for(i = 0;i < FFT_LENGTH;i++)//存储AD数值
	{
		buff[2*i] = Get_Adc(ADC_Channel_5);
	}
		for(i = 0;i < FFT_LENGTH;i++)//存储AD数值
	{
		buff[2*i] = buff[2*i]/4096*3.3f;
		buff[2*i+1]=0;
	}
}
void DrawOscillogram(float *buff)//画波形图
{
	static u16 Ypos1 = 0,Ypos2 = 0;
	u16 i = 0;
	u16 Y_init	=	20;
	POINT_COLOR = YELLOW;
    #if 0
	for(i = 0;i < lcddev.width;i++)
	{
		clear_point(i);	
		Ypos2 = lcddev.height - (Y_init+(u16)(buff[2*i]/3.3f*(lcddev.height-Y_init)));//转换坐标
		//Ypos2 = Ypos2 * bei;
		if(Ypos2 >lcddev.height)
			Ypos2 =lcddev.height; //超出范围不显示
		LCD_DrawLine (i ,Ypos1 , i+1 ,Ypos2);
		Ypos1 = Ypos2 ;
	}
    #endif
    	for(i = 0;i < lcddev.width/2;i++)
	{
		clear_point(i);	
		Ypos2 = lcddev.height - (Y_init+(u16)(buff[2*i]/3.3f*(lcddev.height-Y_init)));//转换坐标
		//Ypos2 = Ypos2 * bei;
		if(Ypos2 >lcddev.height)
			Ypos2 =lcddev.height; //超出范围不显示
		LCD_DrawLine (i ,Ypos1 , i+1 ,Ypos2);
		Ypos1 = Ypos2 ;
	}
    Ypos1 = 0;	
}
void Set_BackGround(void)
{
	POINT_COLOR = YELLOW;
    LCD_Clear(DARKBLUE);
	LCD_DrawRectangle(0,0,lcddev.width,lcddev.height);//矩形
	LCD_DrawLine(0,lcddev.height-20,lcddev.width,lcddev.height-20);//横线
	LCD_DrawLine(lcddev.width/2,0,lcddev.width/2,lcddev.height);//竖线
	POINT_COLOR = WHITE;
	BACK_COLOR = DARKBLUE;
	//LCD_ShowString(30,40,210,24,24,(u8*)"vpp=");	
}

void Lcd_DrawNetwork(void)
{
	u16 index_y = 0;
	u16 index_x = 0;	
	
    //画列点	
	for(index_x = 40;index_x < 480;index_x += 40)
	{
		for(index_y = 10;index_y < 320;index_y += 10)
		{
			LCD_Fast_DrawPoint(index_x,index_y,WHITE);	
		}
	}
	//画行点
	for(index_y = 40;index_y < 320;index_y += 40)
	{
		for(index_x = 10;index_x < 480;index_x += 10)
		{
			LCD_Fast_DrawPoint(index_x,index_y,WHITE);	
		}
	}
}

float get_vpp(float *buf)	   //获取峰峰值
{
	
	float max_data=buf[0];
	float min_data=buf[4];//buf[1];
	u32 n=0;
	float Vpp=0;
	for(n = 0;n<FFT_LENGTH;n++)
	{
		if(buf[2*n] > max_data)
		{
			max_data = buf[2*n];
		}
		if(buf[2*n] < min_data)
		{
			min_data = buf[2*n];
		}			
	} 	
	Vpp = max_data - min_data;
	return Vpp;	
}
void rDawSpectrum(float *buf,u32 f)
{
	u32 n;
	static u16 Ypos1 = 0,Ypos2 = 0;
	n=f/(10500000/492/1024);
	if(FFT_LENGTH-n<lcddev.width/2 && n>lcddev.width/2)
		for(n=n-lcddev.width/2;n<n+lcddev.width/2;n++)
	{
		clear_point(n);	
		Ypos2 = lcddev.height - (lcddev.height/2+(u16)(buf[2*n]/3.3f*lcddev.height/2));//转换坐标
		//Ypos2 = Ypos2 * bei;
		if(Ypos2 >lcddev.height)
			Ypos2 =lcddev.height; //超出范围不显示
		LCD_DrawLine (n ,Ypos1 , n+1 ,Ypos2);
		Ypos1 = Ypos2 ;
	}
		
}
u32 get_freq(float *buff)   //获取频率
{
	u32 n;
	float max_data=buff[1];
	u32 max_freq=1;
	for(n = 1;n<FFT_LENGTH/2 ;n++)
	{
		if(buff[n] > max_data)
		{
			max_data = buff[n];
			max_freq=n;
		}
	}
	max_freq=(u32)(max_freq*(10500000/492/1024)*51/50);
		return max_freq;
}

u32 get_arg(float *buffx,float *buffy)   //获取相位(能用)
{
	u32 n;
	float max_data=buffx[1];
	u32 max_arg=1;
	for(n = 1;n<FFT_LENGTH/2 ;n++)          //峰值
	{
		if(buffx[n] > max_data)
		{
			max_data = buffx[n];
			max_arg=n;
		}
	}
	max_arg=(u32)(atan2(buffy[max_arg*2],buffy[max_arg*2+1])*180/3.1415f);
		return max_arg;
}

void Add_Kwindow(float *buff)
{
	u16 i;
	for(i =0;i<FFT_LENGTH;i++)
	{
		buff[i]=buff[i]*kaiser[i];
	}
}

#if xiangweizhi
//获取峰值
int fft_getpeak(float *inputx,float *input,float *output,u16 inlen,u8 x,u8 N,float y) //  intlen 输入数组长度，x寻找长度
{                                                                           
	int i,i2;
	u32 idex;  //不同于上一个函数中的，因为他们在不同的函数中被定义
	float datas;
	float sum;
	int outlen=0;
	for(i=0;i<inlen-x;i+=x)
	{
		arm_max_f32(input+i,x,&datas,&idex);   
		if( (input[i+idex]>=input[i+idex+1])&&(input[i+idex]>=input[i+idex-1])&&( (2*datas)/FFT_LENGTH )>y)   
		   {
			   sum=0;   
			   for(i2=i+idex-N;i2<i+idex+N;i2++)   
			   {
				   sum+=input[i2];          
			   }        
			   if(1.5*sum/(2*N)<datas)       
			   {                                                                                             
				     output[3*outlen+2] = atan2(inputx[2*(i+idex+1)+1],inputx[2*(i+idex+1)])*180/3.1415926f;				   
				     output[3*outlen+1] = 1.0*(2*datas)/FFT_LENGTH;   //计算幅度
					 output[3*outlen] = 1.0*fft_sample_freq*(i+idex+1)/FFT_LENGTH;//计算频率
					 outlen++;				   
			   }                                                                                               
               else continue;			   
		   }
			
		else continue;
		
	}
	return outlen;	
}
#endif
